<template>
  <component
    :is="elementType"
    ref="collapsible"
    v-on="$listeners"
  >
    <!-- Element for capturing keypresses -->
    <div
      :id="!ariaLabelledBy && labelledBy"
      ref="anchor"
      @click.capture="defaultToggleOpen"
      @keydown.enter="defaultToggleOpen"
      @keydown.space="defaultToggleOpen"
    >
      <!-- @slot Slot for the anchor element that toggles the collapsible content -->
      <slot
        name="anchor"
        :attrs="{
          'aria-controls': id,
          'aria-expanded': isOpen.toString(),
        }"
      >
        <dt-button
          importance="clear"
          kind="muted"
          :aria-controls="id"
          :aria-expanded="`${isOpen}`"
          :style="{
            'width': maxWidth,
          }"
        >
          <icon-arrow-accordion-open
            v-if="isOpen"
            class="d-svg--size18 d-mr8 d-fl-shrink0"
          />
          <icon-arrow-accordion-closed
            v-else
            class="d-svg--size18 d-mr8 d-fl-shrink0"
          />
          <span
            class="d-mr-auto d-truncate"
            :title="anchorText"
          >
            {{ anchorText }}
          </span>
        </dt-button>
      </slot>
    </div>
    <dt-collapsible-lazy-show
      ref="content"
      :aria-hidden="`${!isOpen}`"
      :aria-labelledby="labelledBy"
      :aria-label="ariaLabel"
      :show="isOpen"
      class="dt-collapsible__content"
      :style="{
        'max-height': maxHeight,
        'max-width': maxWidth,
      }"
      tabindex="-1"
      appear
      v-on="$listeners"
      @after-leave="onLeaveTransitionComplete"
      @after-enter="onEnterTransitionComplete"
    >
      <component
        :is="contentType"
        :id="id"
        ref="contentWrapper"
      >
        <!-- @slot Slot for the collapsible element that is expanded by the anchor -->
        <slot
          name="content"
        />
      </component>
    </dt-collapsible-lazy-show>
  </component>
</template>

<script>
import { getUniqueString } from '@/common/utils';
import DtCollapsibleLazyShow from './collapsible_lazy_show';
import { DtButton } from '../button';
import { DtLazyShow } from '../lazy_show';
import IconArrowAccordionOpen from '@dialpad/dialtone/lib/dist/vue/icons/IconArrowAccordionOpen';
import IconArrowAccordionClosed from '@dialpad/dialtone/lib/dist/vue/icons/IconArrowAccordionClosed';
import ModalMixin from '@/common/mixins/modal.js';

export default {
  name: 'DtCollapsible',

  components: {
    DtButton,
    DtCollapsibleLazyShow,
    DtLazyShow,
    IconArrowAccordionOpen,
    IconArrowAccordionClosed,
  },

  mixins: [
    ModalMixin,
  ],

  props: {
    /**
     * Text that is displayed on the anchor if nothing is passed in the slot.
     * Ignored if the anchor slot is used.
     */
    anchorText: {
      type: String,
      default: null,
    },

    /**
     * Controls whether the collapsible is shown. Leaving this null will have the collapsible start
     * expanded and trigger on click by default. If you set this value, the default trigger
     * behavior will be disabled and you can control it as you need.
     * Supports .sync modifier
     */
    open: {
      type: Boolean,
      default: null,
    },

    /**
     * The id of the content wrapper.
     */
    id: {
      type: String,
      default () { return getUniqueString(); },
    },

    /**
     * Element type (tag name) of the root element of the component.
     */
    elementType: {
      type: String,
      default: 'div',
    },

    /**
     * Element type (tag name) of the content wrapper element.
     */
    contentType: {
      type: String,
      default: 'div',
    },

    /**
     * The maximum width of the anchor and collapsible element.
     */
    maxWidth: {
      type: String,
      default: null,
    },

    /**
     * The maximum height of the collapsible element.
     */
    maxHeight: {
      type: String,
      default: null,
    },

    /**
     * Label on the collapsible content. Should provide this of ariaLabelledBy but not both.
     */
    ariaLabel: {
      type: String,
      default: null,
    },

    /**
     * Id of the element that labels the collapsible content. Defaults to the anchor element.
     * Should provide this or ariaLabel but not both.
     */
    ariaLabelledBy: {
      type: String,
      default: null,
    },
  },

  emits: ['update:open', 'opened'],

  data () {
    return {
      isOpen: true,
    };
  },

  computed: {
    labelledBy () {
      // aria-labelledby should be set only if aria-labelledby is passed as a prop, or if
      // there is no aria-label and the labelledby should point to the anchor
      return this.ariaLabelledby || (!this.ariaLabel && getUniqueString('DtCollapsible__anchor'));
    },

    contentStyle () {
      return {
        'max-height': this.maxHeight,
        'max-width': this.maxWidth,
      };
    },
  },

  watch: {
    open: {
      handler: function (open) {
        if (open !== null) {
          this.isOpen = open;
        }
      },

      immediate: true,
    },
  },

  methods: {
    async onLeaveTransitionComplete () {
      this.$emit('opened', false);
      if (this.open !== null) {
        this.$emit('update:open', false);
      }
    },

    async onEnterTransitionComplete () {
      this.$emit('opened', true, this.$refs.content);
      if (this.open !== null) {
        this.$emit('update:open', true);
      }
    },

    defaultToggleOpen () {
      if (this.open === null) {
        this.toggleOpen();
      }
    },

    toggleOpen () {
      this.isOpen = !this.isOpen;
    },
  },
};
</script>
